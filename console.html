<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JavaScript Code Editor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="/data-loader.js"></script>
<script src="/calc-engine.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Courier New', monospace;
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 20px;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  
  h1 {
    color: #4ec9b0;
    margin-bottom: 10px;
    font-size: 18px;
  }
  
  .container {
    display: flex;
    flex-direction: column;
    flex: 1;
    gap: 10px;
  }
  
  .editor-section {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  
  .editor-label {
    color: #9cdcfe;
    margin-bottom: 5px;
    font-size: 12px;
  }
  
  textarea {
    flex: 1;
    background: #252525;
    border: 1px solid #3e3e3e;
    color: #d4d4d4;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    resize: none;
    line-height: 1.5;
  }
  
  .output-section {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  
  .output {
    flex: 1;
    background: #252525;
    border: 1px solid #3e3e3e;
    padding: 15px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 14px;
  }
  
  .output.error {
    color: #f48771;
  }
  
  .output.success {
    color: #4ec9b0;
  }
  
  .controls {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  
  button {
    background: #0e639c;
    color: white;
    border: none;
    padding: 12px 30px;
    cursor: pointer;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    font-weight: bold;
  }
  
  button:hover {
    background: #1177bb;
  }
  
  button.secondary {
    background: #2d2d30;
    border: 1px solid #555;
  }
  
  button.secondary:hover {
    background: #3e3e42;
  }
  
  .status {
    color: #9cdcfe;
    font-size: 12px;
    padding: 5px 0;
  }
</style>
</head>
<body>

<h1>üìù JavaScript Code Editor</h1>
<div class="status" id="status">Ready. Excel files load when you run code.</div>

<div class="container">
  <div class="editor-section">
    <div class="editor-label">CODE EDITOR (write your code here):</div>
    <textarea id="codeEditor">// Load Excel files
const data = await window.dataLoader.loadAll();
const rateTables = data.rateTables;     
const mortality = data.mortality;        
const marketHistory = data.marketHistory; 
// Your code here:

     
</textarea>
  </div>
  
  <div class="output-section">
    <div class="editor-label">OUTPUT:</div>
    <div class="output success" id="output">Click "Run Code" to execute your code...</div>
  </div>
</div>

<div class="controls">
  <button onclick="runCode()">‚ñ∂ Run Code</button>
  <button class="secondary" onclick="clearOutput()">Clear Output</button>
  <button class="secondary" onclick="resetCode()">Reset Code</button>
</div>

<script>
let engineReady = true;

let consoleOutput = [];
const originalLog = console.log;
const originalTable = console.table;

console.log = function(...args) {
  originalLog.apply(console, args);
  consoleOutput.push(args.map(arg => 
    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
  ).join(' '));
};

console.table = function(data) {
  originalTable.apply(console, arguments);
  
  if (Array.isArray(data)) {
    let tableStr = '';
    
    if (data.length > 0 && Array.isArray(data[0])) {
      // 2D array
      const numCols = data[0].length;
      
      // Check if first row contains headers (strings with $)
      const headers = data[0].map(cell => String(cell));
      const hasHeaders = headers.some(h => h.includes('$'));
      const dataStartRow = hasHeaders ? 1 : 0;
      
      // Format function
      function formatCell(value, colIdx) {
        if (value === null || value === undefined) return 'null';
        if (typeof value !== 'number') return String(value);
        
        // If header has $, always 2 decimals
        if (hasHeaders && headers[colIdx].includes('$')) {
          return value.toFixed(2);
        }
        
        // Otherwise max 4 decimals, strip trailing zeros
        let str = value.toFixed(4);
        str = str.replace(/\.?0+$/, '');
        return str;
      }
      
      // Calculate widths
      const colWidths = [];
      for (let colIdx = 0; colIdx < numCols; colIdx++) {
        let maxWidth = headers[colIdx].length;
        for (let i = dataStartRow; i < data.length; i++) {
          const formatted = formatCell(data[i][colIdx], colIdx);
          maxWidth = Math.max(maxWidth, formatted.length);
        }
        colWidths.push(maxWidth);
      }
      
      // Build table
      tableStr = '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨' + colWidths.map(w => '‚îÄ'.repeat(w)).join('‚î¨') + '‚îê\n';
      tableStr += '‚îÇ idx ‚îÇ' + headers.map((h, i) => h.padEnd(colWidths[i])).join('‚îÇ') + '‚îÇ\n';
      tableStr += '‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº' + colWidths.map(w => '‚îÄ'.repeat(w)).join('‚îº') + '‚î§\n';
      
      for (let rowIdx = dataStartRow; rowIdx < data.length; rowIdx++) {
        tableStr += `‚îÇ ${String(rowIdx).padEnd(3)} ‚îÇ`;
        tableStr += data[rowIdx].map((cell, colIdx) => {
          return formatCell(cell, colIdx).padEnd(colWidths[colIdx]);
        }).join('‚îÇ');
        tableStr += '‚îÇ\n';
      }
      
      tableStr += '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥' + colWidths.map(w => '‚îÄ'.repeat(w)).join('‚î¥') + '‚îò';
    } else {
      tableStr = JSON.stringify(data, null, 2);
    }
    
    consoleOutput.push(tableStr);
  } else {
    consoleOutput.push(JSON.stringify(data, null, 2));
  }
};

async function runCode() {
  const code = document.getElementById('codeEditor').value;
  const output = document.getElementById('output');
  
  consoleOutput = [];
  output.className = 'output';
  output.textContent = 'Running...\n\n';
  
  try {
    // Use AsyncFunction constructor to support top-level await
    const AsyncFunction = async function () {}.constructor;
    const fn = new AsyncFunction(code);
    const result = await fn();
    
    let finalOutput = '';
    if (consoleOutput.length > 0) {
      finalOutput += 'üìã Console Output:\n' + consoleOutput.join('\n') + '\n\n';
    }
    
    if (result !== undefined) {
      finalOutput += 'üì§ Returned Value:\n';
      if (typeof result === 'object') {
        finalOutput += JSON.stringify(result, null, 2);
      } else {
        finalOutput += String(result);
      }
    }
    
    output.className = 'output success';
    output.textContent = finalOutput || '‚úì Code executed successfully (no output)';
    
  } catch (err) {
    output.className = 'output error';
    output.textContent = '‚úó Error:\n' + err.message + '\n\n' + err.stack;
  }
}

function clearOutput() {
  document.getElementById('output').className = 'output success';
  document.getElementById('output').textContent = 'Output cleared.';
}

function resetCode() {
  document.getElementById('codeEditor').value = `// Load Excel files
const rateTables = await window.dataLoader.loadExcel('RateTables.xlsx', 'LI_RATES');
const mortality = await window.dataLoader.loadExcel('Mortality.xlsx', 'Mortality');
const marketHistory = await window.dataLoader.loadExcel('MarketHistory.xlsx', 'Market');

// Your code here:

`;
  clearOutput();
}
</script>

</body>
</html>
