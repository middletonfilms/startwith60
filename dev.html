<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculator Dev Tool | StartWith60</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="/data-loader.js"></script>
<script src="/calc-engine.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: Arial, sans-serif;
    background: white;
    color: #333;
    padding: 20px;
    font-size: 13px;
  }
  
  h1 {
    font-size: 20px;
    margin-bottom: 15px;
  }
  
  h2 {
    font-size: 14px;
    margin-top: 15px;
    margin-bottom: 8px;
    font-weight: bold;
  }
  
  .input-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
  }
  
  .input-row label {
    width: 200px;
    font-size: 12px;
  }
  
  .input-row input,
  .input-row select {
    width: 120px;
    padding: 4px;
    border: 1px solid #ccc;
    background: #f5f5f5;
    font-size: 12px;
  }
  
  /* Remove spinner arrows */
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  
  input[type="number"] {
    -moz-appearance: textfield;
  }
  
  .input-row .readonly {
    background: #e9e9e9;
    color: #666;
  }
  
  .input-row .override {
    background: #e3f2fd;
  }
  
  button {
    margin-top: 10px;
    padding: 8px 20px;
    border: 1px solid #ccc;
    background: #f0f0f0;
    cursor: pointer;
    font-size: 13px;
  }
  
  button:hover {
    background: #e0e0e0;
  }
  
  .tables-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
  }
  
  th {
    background: #e9e9e9;
    padding: 4px;
    border: 1px solid #ccc;
    font-weight: bold;
    text-align: left;
    font-size: 10px;
    white-space: nowrap;
  }
  
  td {
    padding: 3px 4px;
    border: 1px solid #ddd;
    text-align: left;
    white-space: nowrap;
  }
  
  tr:nth-child(even) {
    background: #fafafa;
  }
  
  .array-table {
    margin-top: 15px;
    font-size: 10px;
    width: auto;
    table-layout: auto;
  }
  
  .array-table th {
    position: sticky;
    top: 0;
    background: #e9e9e9;
    font-size: 9px;
    padding: 3px 5px;
    white-space: nowrap;
  }
  
  .array-table td {
    padding: 2px 5px;
    text-align: right;
    white-space: nowrap;
  }
  
  .array-table td:first-child,
  .array-table td:nth-child(2) {
    text-align: center;
    font-weight: bold;
  }
  
  /* Column background colors */
  .col-grey {
    background: #f0f0f0 !important;
  }
  
  .col-blue {
    background: #e3f2fd !important;
  }
  
  .col-green {
    background: #e8f5e9 !important;
  }
  
  .error {
    background: #fee;
    color: #c00;
    padding: 10px;
    border: 1px solid #fcc;
    margin: 10px 0;
  }
  
  #results {
    display: none;
  }
  
  #results.visible {
    display: block;
  }
</style>
</head>
<body>

<h1>Calculator Dev Tool</h1>

<div>
  <h2>Global Variables</h2>
  <div class="input-row">
    <label>Market Gain (%):</label>
    <input type="number" id="marketGain" value="10.4" step="0.1" oninput="handleMarketGainInput()">
  </div>
  <div class="input-row">
    <label>Inflation Rate (%):</label>
    <input type="number" id="inflation" value="3.28" step="0.01">
  </div>
  
  <h2>Budget & Insurance</h2>
  <div class="input-row">
    <label>Monthly Budget ($):</label>
    <input type="number" id="monthlyBudget" value="100" oninput="handleBudgetInput()">
    <span style="margin: 0 10px;">OR</span>
    <label>Whole Life Policy ($):</label>
    <input type="number" id="policySize" value="60000" class="override" oninput="handlePolicyInput()">
  </div>
  <div class="input-row">
    <label>Term Length (Years):</label>
    <input type="number" id="termPolicy" placeholder="Leave empty if none">
  </div>
  <div class="input-row">
    <label>Term Budget ($/mo):</label>
    <input type="number" id="termBudget" value="0">
  </div>
  
  <h2>Personal Info</h2>
  <div class="input-row">
    <label>Sex:</label>
    <select id="sex" onchange="updateTimeHorizons()">
      <option value="male">Male</option>
      <option value="female">Female</option>
    </select>
  </div>
  <div class="input-row">
    <label>Current Age:</label>
    <input type="number" id="age" value="35" oninput="updateTimeHorizons()">
  </div>
  <div class="input-row">
    <label>Tobacco User:</label>
    <select id="tobaccoUser">
      <option value="false">No</option>
      <option value="true">Yes</option>
    </select>
  </div>
  
  <h2>Time Horizons</h2>
  <div class="input-row">
    <label>Retirement Age:</label>
    <input type="number" id="retirementAge" value="65" oninput="updateTimeHorizons()">
    <span style="margin-left: 10px; color: #666;">Time Horizon Retire:</span>
    <input type="text" id="timeHorizonRetire" class="readonly" readonly style="width: 50px;">
    <span style="margin-left: 10px; color: #666;">Market Gain Retire:</span>
    <input type="text" id="marketGainRetire" class="readonly" readonly style="width: 100px;">
  </div>
  <div class="input-row">
    <label>Life Expectancy:</label>
    <input type="number" id="lifeExpectancy" value="76" oninput="updateTimeHorizons()">
    <span style="margin-left: 10px; color: #666;">Time Horizon Death:</span>
    <input type="text" id="timeHorizonDeath" class="readonly" readonly style="width: 50px;">
    <span style="margin-left: 10px; color: #666;">Market Gain Death:</span>
    <input type="text" id="marketGainDeath" class="readonly" readonly style="width: 100px;">
  </div>
  <div class="input-row">
    <label>Custom Age Cutoff:</label>
    <input type="number" id="customAgeCutoff" placeholder="Leave empty" oninput="updateTimeHorizons()">
    <span style="margin-left: 10px; color: #666;">Time Horizon Custom:</span>
    <input type="text" id="timeHorizonCustom" class="readonly" readonly style="width: 50px;">
    <span style="margin-left: 10px; color: #666;">Market Gain Custom:</span>
    <input type="text" id="marketGainCustom" class="readonly" readonly style="width: 100px;">
  </div>
  
  <h2>Advanced</h2>
  <div class="input-row">
    <label>Performance Percentile (%):</label>
    <input type="number" id="performancePercentile" class="override" placeholder="Leave empty for default" oninput="handlePercentileInput()">
  </div>
  
  <button onclick="runCalculation()">Run Calculation</button>
</div>

<div id="loading" style="display:none; margin: 10px 0; color: #666;">Loading data files...</div>
<div id="error" class="error" style="display:none;"></div>

<div id="results">
  <div class="tables-container">
    <div>
      <h2>Global Variables</h2>
      <table id="globals-table"></table>
    </div>
    
    <div>
      <h2>User Inputs</h2>
      <table id="inputs-table"></table>
    </div>
    
    <div>
      <h2>Time Horizons</h2>
      <table id="horizons-table"></table>
    </div>
    
    <div>
      <h2>Insurance Rates</h2>
      <table id="insurance-table"></table>
    </div>
    
    <div>
      <h2>Final Results</h2>
      <table id="results-table"></table>
    </div>
  </div>
  
  <h2>Year-by-Year Breakdown</h2>
  <div id="arrays-container"></div>
</div>

<script>
let calcReady = false;

async function init() {
  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  
  loading.style.display = 'block';
  
  try {
    await initCalcEngine();
    calcReady = true;
    loading.style.display = 'none';
    updateTimeHorizons();
  } catch (err) {
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = `Error loading data: ${err.message}`;
    console.error(err);
  }
}

function handleBudgetInput() {
  const budget = document.getElementById('monthlyBudget');
  const policy = document.getElementById('policySize');
  
  if (budget.value) {
    policy.classList.add('override');
    policy.value = ''; // Clear policy when budget is entered
  } else {
    policy.classList.remove('override');
  }
}

function handlePolicyInput() {
  const budget = document.getElementById('monthlyBudget');
  const policy = document.getElementById('policySize');
  
  if (policy.value) {
    budget.classList.add('override');
    // Calculate budget from policy (this is just a placeholder calculation)
    // You'd use actual rate table logic here
    budget.value = ''; // Clear budget when policy is entered
  } else {
    budget.classList.remove('override');
  }
}

function handleMarketGainInput() {
  const marketGain = document.getElementById('marketGain');
  const percentile = document.getElementById('performancePercentile');
  
  if (marketGain.value) {
    percentile.classList.add('override');
  }
  
  updateTimeHorizons();
}

function handlePercentileInput() {
  const marketGain = document.getElementById('marketGain');
  const percentile = document.getElementById('performancePercentile');
  
  if (percentile.value) {
    marketGain.classList.add('override');
  } else {
    marketGain.classList.remove('override');
  }
  
  updateTimeHorizons();
}

function updateTimeHorizons() {
  const age = parseInt(document.getElementById('age').value) || 35;
  const retirementAge = parseInt(document.getElementById('retirementAge').value) || 65;
  const lifeExpectancy = parseInt(document.getElementById('lifeExpectancy').value) || 76;
  const customAgeCutoff = parseInt(document.getElementById('customAgeCutoff').value) || null;
  const marketGain = parseFloat(document.getElementById('marketGain').value) || 10.4;
  const percentile = parseFloat(document.getElementById('performancePercentile').value) || null;
  
  const timeHorizonRetire = retirementAge - age;
  const timeHorizonDeath = lifeExpectancy - age;
  const timeHorizonCustom = customAgeCutoff ? customAgeCutoff - age : null;
  
  document.getElementById('timeHorizonRetire').value = timeHorizonRetire;
  document.getElementById('timeHorizonDeath').value = timeHorizonDeath;
  document.getElementById('timeHorizonCustom').value = timeHorizonCustom !== null ? timeHorizonCustom : '';
  
  // Market gains - either from percentile lookup or default market gain
  // For now, just show the market gain percentage
  const marketGainDisplay = percentile ? `${percentile}th percentile` : `${marketGain}%`;
  document.getElementById('marketGainRetire').value = marketGainDisplay;
  document.getElementById('marketGainDeath').value = marketGainDisplay;
  document.getElementById('marketGainCustom').value = timeHorizonCustom !== null ? marketGainDisplay : '';
}

function runCalculation() {
  if (!calcReady) {
    alert('Calculator not ready yet. Please wait...');
    return;
  }
  
  const inputs = {
    inflation: parseFloat(document.getElementById('inflation').value) / 100,
    marketGain: parseFloat(document.getElementById('marketGain').value) / 100,
    retirementAge: parseInt(document.getElementById('retirementAge').value),
    lifeExpectancy: parseInt(document.getElementById('lifeExpectancy').value),
    tobaccoUser: document.getElementById('tobaccoUser').value === 'true',
    age: parseInt(document.getElementById('age').value),
    sex: document.getElementById('sex').value,
    monthlyBudget: parseFloat(document.getElementById('monthlyBudget').value) || 0,
    policySize: parseFloat(document.getElementById('policySize').value) || 0,
    termPolicy: parseInt(document.getElementById('termPolicy').value) || null,
    termBudget: parseFloat(document.getElementById('termBudget').value) || 0,
    customTimeHorizon: parseInt(document.getElementById('customAgeCutoff').value) ? 
      parseInt(document.getElementById('customAgeCutoff').value) - parseInt(document.getElementById('age').value) : null,
    performancePercentile: parseFloat(document.getElementById('performancePercentile').value) || null
  };
  
  const result = window.calcEngine.calculate(inputs);
  displayResults(result);
}

function displayResults(result) {
  const resultsDiv = document.getElementById('results');
  resultsDiv.classList.add('visible');
  
  displayVariableTable('globals-table', result.globals);
  displayVariableTable('inputs-table', result.inputs);
  displayVariableTable('horizons-table', result.timeHorizons);
  displayVariableTable('insurance-table', result.insurance);
  displayVariableTable('results-table', result.results);
  displayArrays(result.arrays, parseInt(document.getElementById('age').value));
}

function displayVariableTable(tableId, variables) {
  const table = document.getElementById(tableId);
  table.innerHTML = '';
  
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th>Variable</th><th>Value</th></tr>';
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  for (const [key, value] of Object.entries(variables)) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${key}</td>
      <td>${formatValue(value, key)}</td>
    `;
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
}

function displayArrays(arrays, currentAge) {
  const container = document.getElementById('arrays-container');
  container.innerHTML = '';
  
  const maxLength = Math.max(...Object.values(arrays).map(arr => arr.length));
  
  const table = document.createElement('table');
  table.className = 'array-table';
  
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th>Year</th><th>Age</th>';
  
  const columnNames = Object.keys(arrays).filter(k => k !== 'year');
  for (const key of columnNames) {
    headerRow.innerHTML += `<th>${key}</th>`;
  }
  thead.appendChild(headerRow);
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  for (let i = 0; i < maxLength; i++) {
    const row = document.createElement('tr');
    const age = currentAge + i;
    row.innerHTML = `<td>${i}</td><td>${age}</td>`;
    
    columnNames.forEach(key => {
      const arr = arrays[key];
      const value = arr[i];
      
      let cellClass = '';
      if (['marketGainsTotal', 'paidInTotal', 'payInYearAdjusted', 'paidInTotalAdjusted', 'totalInAccountAdjusted'].includes(key)) {
        cellClass = 'col-grey';
      } else if (key === 'accountIfWindowEnded') {
        cellClass = 'col-blue';
      } else if (key === 'totalInAccount') {
        cellClass = 'col-green';
      }
      
      row.innerHTML += `<td class="${cellClass}">${formatValue(value, key)}</td>`;
    });
    
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
  
  container.appendChild(table);
}

function formatValue(value, key) {
  if (value === null || value === undefined) {
    return '-';
  }
  if (typeof value === 'number') {
    // No decimals for years/ages
    if (key && (key.includes('AGE') || key.includes('YEAR') || key.includes('HORIZON') || key === 'year')) {
      return Math.round(value).toString();
    }
    // 4 decimals for inflationValue
    if (key === 'inflationValue') {
      return value.toFixed(4);
    }
    // 2 decimals for dollar amounts
    if (value > 100 || value < -100) {
      return value.toLocaleString('en-US', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    }
    return value.toFixed(4);
  }
  if (typeof value === 'boolean') {
    return value ? 'Yes' : 'No';
  }
  return String(value);
}

init();
</script>

</body>
</html>
