<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculator Dev Tool | StartWith60</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="/data-loader.js"></script>
<script src="/calc-engine.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

 body {
    font-family: Arial, sans-serif;
    background: white;
    color: #333;
    padding: 20px;
    font-size: 13px;
  }
  
  h1 { font-size: 20px; margin-bottom: 15px; }
  h2 { font-size: 14px; margin-top: 15px; margin-bottom: 8px; font-weight: bold; }
  
  .input-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
  }
  
  .input-row label {
    width: 200px;
    font-size: 12px;
  }
  
  .input-row input,
  .input-row select {
    width: 120px;
    padding: 4px;
    border: 1px solid #ccc;
    background: #f5f5f5;
    font-size: 12px;
  }
  
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  
  input[type="number"] { -moz-appearance: textfield; }
  
  .readonly {
    background: #e9e9e9;
    color: #666;
  }
  
  .override {
    background: #e3f2fd;
  }
  
  button {
    margin-top: 10px;
    padding: 8px 20px;
    border: 1px solid #ccc;
    background: #f0f0f0;
    cursor: pointer;
    font-size: 13px;
  }
  
  button:hover { background: #e0e0e0; }
  
  .tables-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
  }
  
  th {
    background: #e9e9e9;
    padding: 4px;
    border: 1px solid #ccc;
    font-weight: bold;
    text-align: left;
    font-size: 10px;
    white-space: nowrap;
  }
  
  td {
    padding: 3px 4px;
    border: 1px solid #ddd;
    text-align: left;
    white-space: nowrap;
  }
  
  tr:nth-child(even) { background: #fafafa; }
  
  .rate-table-cell {
    text-align: center;
  }
  
  .active-rate {
    background: #e8f5e9 !important;
    font-weight: bold;
  }
  
  .array-table {
    margin-top: 15px;
    font-size: 10px;
    width: auto;
    table-layout: auto;
  }
  
  .array-table th {
    position: sticky;
    top: 0;
    background: #e9e9e9;
    font-size: 9px;
    padding: 3px 5px;
    white-space: nowrap;
  }
  
  .array-table td {
    padding: 2px 5px;
    text-align: right;
    white-space: nowrap;
  }
  
  .array-table td:first-child,
  .array-table td:nth-child(2) {
    text-align: center;
    font-weight: bold;
  }
  
  .col-grey { background: #f0f0f0 !important; }
  .col-blue { background: #e3f2fd !important; }
  .col-green { background: #e8f5e9 !important; }
  
  .error {
    background: #fee;
    color: #c00;
    padding: 10px;
    border: 1px solid #fcc;
    margin: 10px 0;
  }
  
  #results { display: none; }
  #results.visible { display: block; }
</style>
</head>
<body>

<div style="position: fixed; top: 10px; right: 10px; background: #fee; color: #c00; padding: 5px 10px; border: 1px solid #fcc; font-size: 11px; border-radius: 3px; z-index: 1000;">
  Last Updated: <span id="last-updated"></span>
</div>

<h1>Calculator Dev Tool</h1>

<div>
  <h2>Global Variables</h2>
  <div class="input-row">
    <label>Market Gain (%):</label>
    <input type="number" id="marketGain" value="10.4" step="0.1" oninput="handleMarketGainInput()">
  </div>
  <div class="input-row">
    <label>Inflation Rate (%):</label>
    <input type="number" id="inflation" value="3.28" step="0.01" oninput="runCalculation()">
  </div>
 
<h2>Personal Info</h2>
  <div class="input-row">
    <label>Sex:</label>
    <select id="sex" onchange="handleSexChange()">
      <option value="">Select...</option>
      <option value="male">Male</option>
      <option value="female">Female</option>
    </select>
  </div>
  <div class="input-row">
    <label>Current Age:</label>
    <input type="number" id="age" value="" oninput="handlePersonalInfoChange()">
  </div>
  <div class="input-row">
    <label>Tobacco User:</label>
    <select id="tobaccoUser" onchange="handlePersonalInfoChange()">
      <option value="false">No</option>
      <option value="true">Yes</option>
    </select>
  </div>
 
  <h2>Budget & Insurance</h2>
  <div class="input-row">
    <label>Monthly Budget ($):</label>
    <input type="number" id="monthlyBudget" placeholder="Enter amount" oninput="handleBudgetInput()">
    <span style="margin: 0 10px;">OR</span>
    <label>Whole Life Policy ($):</label>
    <input type="number" id="policySize" class="override" placeholder="Enter amount" oninput="handlePolicyInput()">
  </div>
  <div class="input-row">
    <label>Term Length (Years):</label>
    <input type="number" id="termPolicy" placeholder="Leave empty if none" oninput="runCalculation()">
  </div>
  <div class="input-row">
    <label>Term Budget ($/mo):</label>
    <input type="number" id="termBudget" value="0" oninput="runCalculation()">
  </div>

   <h2>Time Horizons</h2>
  <div class="input-row">
    <label>Retirement Age:</label>
    <input type="number" id="retirementAge" value="65" oninput="updateTimeHorizons()">
    <span style="margin-left: 10px; color: #666;">Time Horizon Retire:</span>
    <input type="text" id="timeHorizonRetire" class="readonly" readonly style="width: 50px;">
    <span style="margin-left: 10px; color: #666;">Market Gain Retire:</span>
    <input type="text" id="marketGainRetire" class="readonly" readonly style="width: 100px;">
    <span style="margin-left: 10px; color: #666;">Account Value:</span>
    <input type="text" id="accountValueRetire" class="readonly" readonly style="width: 120px;">
  </div>
  <div class="input-row">
    <label>Life Expectancy:</label>
    <input type="number" id="lifeExpectancy" placeholder="Auto-fills from sex" oninput="updateTimeHorizons()">
    <span style="margin-left: 10px; color: #666;">Time Horizon Death:</span>
    <input type="text" id="timeHorizonDeath" class="readonly" readonly style="width: 50px;">
    <span style="margin-left: 10px; color: #666;">Market Gain Death:</span>
    <input type="text" id="marketGainDeath" class="readonly" readonly style="width: 100px;">
    <span style="margin-left: 10px; color: #666;">Account Value:</span>
    <input type="text" id="accountValueDeath" class="readonly" readonly style="width: 120px;">
  </div>
  <div class="input-row">
    <label>Custom Age Cutoff:</label>
    <input type="number" id="customAgeCutoff" placeholder="Leave empty" oninput="updateTimeHorizons()">
    <span style="margin-left: 10px; color: #666;">Time Horizon Custom:</span>
    <input type="text" id="timeHorizonCustom" class="readonly" readonly style="width: 50px;">
    <span style="margin-left: 10px; color: #666;">Market Gain Custom:</span>
    <input type="text" id="marketGainCustom" class="readonly" readonly style="width: 100px;">
    <span style="margin-left: 10px; color: #666;">Account Value:</span>
    <input type="text" id="accountValueCustom" class="readonly" readonly style="width: 120px;">
  </div>
  
  <h2>Advanced</h2>
  <div class="input-row">
    <label>Performance Percentile (%):</label>
    <input type="number" id="performancePercentile" class="override" placeholder="Leave empty for default" oninput="handlePercentileInput()">
  </div>
  
</div>

<div id="loading" style="display:none; margin: 10px 0; color: #666;">Loading data files...</div>
<div id="error" class="error" style="display:none;"></div>

<div id="results">
  <h2>Insurance Rate Table (Age <span id="rateTableAge"></span>, <span id="rateTableSex"></span>)</h2>
  <table id="rate-table"></table>
  
  <div class="tables-container">
    <div>
      <h2>Global Variables</h2>
      <table id="globals-table"></table>
    </div>
    
    <div>
      <h2>User Inputs</h2>
      <table id="inputs-table"></table>
    </div>
    
    <div>
      <h2>Time Horizons</h2>
      <table id="horizons-table"></table>
    </div>
    
    <div>
      <h2>Insurance Rates</h2>
      <table id="insurance-table"></table>
    </div>
    
    <div>
      <h2>Final Results</h2>
      <table id="results-table"></table>
    </div>
  </div>
  
  <h2>Year-by-Year Breakdown</h2>
  <div id="arrays-container"></div>
</div>

<script>
let calcReady = false;
let cagrPercentiles = {};
let rawRateData = null;

async function init() {
  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  
  loading.style.display = 'block';
  
  try {
    await initCalcEngine();
    await loadCAGRPercentiles();
    await loadRateTableData();
    calcReady = true;
    loading.style.display = 'none';
    updateTimeHorizons();
  } catch (err) {
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = `Error loading data: ${err.message}`;
    console.error(err);
  }
}

async function loadRateTableData() {
  rawRateData = await window.dataLoader.loadExcel('RateTables.xlsx', 'LI_RATES');
}

async function loadCAGRPercentiles() {
  const marketData = await window.dataLoader.loadExcel('MarketHistory.xlsx', 'Market');
  
  for (let row = 1386; row <= 1402; row++) {
    const percentile = marketData[row][2];
    if (percentile) {
      cagrPercentiles[percentile] = {};
      for (let col = 3; col < marketData[row].length; col++) {
        const yearSpan = col - 2;
        const cagr = marketData[row][col];
        if (cagr !== null && cagr !== undefined) {
          cagrPercentiles[percentile][yearSpan] = cagr;
        }
      }
    }
  }
}

function getCAGRForPercentile(percentile, years) {
  if (years > 80) return 10.4;
  
  // Fallback to old method if marketHistory not available
  if (!window.calcEngine || !window.calcEngine.data || !window.calcEngine.data.marketHistory) {
    const pct = percentile / 100;
    const available = Object.keys(cagrPercentiles).map(Number).sort((a,b) => a-b);
    let closest = available[0];
    let minDiff = Math.abs(pct - closest);
    
    for (const p of available) {
      const diff = Math.abs(pct - p);
      if (diff < minDiff) {
        minDiff = diff;
        closest = p;
      }
    }
    
    const cagr = cagrPercentiles[closest][years];
    if (!cagr) return null;
    return ((cagr - 1) * 100).toFixed(2);
  }
  
  const history = window.calcEngine.data.marketHistory;
  const performances = [];
  
  for (const entry of history) {
    const growth = entry.growth[years];
    if (growth !== null && growth !== undefined) {
      performances.push(growth);
    }
  }
  
  if (performances.length === 0) return null;
  
  performances.sort((a, b) => a - b);
  const index = Math.floor((percentile / 100) * (performances.length - 1));
  const cagr = performances[index];
  
  return ((cagr - 1) * 100).toFixed(2);
}

function getRateBrackets(age, sex) {
  let ageRow = null;
  for (let i = 4; i < rawRateData.length; i++) {
    if (rawRateData[i][0] === age) {
      ageRow = rawRateData[i];
      break;
    }
  }
  
  if (!ageRow) return null;
  
  const isMinor = age < 18;
  const brackets = [];
  
  if (sex === 'male') {
    brackets.push({
      name: 'Standard',
      range: isMinor ? '$0-$15,099' : '$0-$34,999',
      ratePerThousand: ageRow[1],
      monthlyCutoff: ageRow[2]
    });
    brackets.push({
      name: 'Preferred',
      range: isMinor ? '$15,100-$59,999' : '$35,000-$59,999',
      ratePerThousand: ageRow[5],
      monthlyCutoff: ageRow[6]
    });
    brackets.push({
      name: 'Executive',
      range: isMinor ? '$60,000-$9,999,999' : '$60,000-$119,999',
      ratePerThousand: ageRow[9],
      monthlyCutoff: ageRow[10]
    });
    
    if (isMinor) {
      brackets.push({
        name: 'Select',
        range: '-',
        ratePerThousand: null,
        monthlyCutoff: null
      });
    } else {
      // For adults, Select bracket exists
      // Rate at col 13, but cutoff is stored as coverage ceiling (9999999) not monthly premium
      // Calculate monthly cutoff from rate and coverage ceiling
      const selectRate = ageRow[13];
      const selectCeiling = ageRow[14]; // This is 9999999
      // Monthly cutoff = (ceiling / 1000) * rate / 12
      const selectCutoff = selectCeiling !== 9999999 ? (selectCeiling / 1000) * selectRate / 12 : null;
      
      brackets.push({
        name: 'Select',
        range: '$120,000-$9,999,999',
        ratePerThousand: selectRate,
        monthlyCutoff: selectCutoff
      });
    }
  } else { // female
    brackets.push({
      name: 'Standard',
      range: isMinor ? '$0-$15,099' : '$0-$34,999',
      ratePerThousand: ageRow[3],
      monthlyCutoff: ageRow[4]
    });
    brackets.push({
      name: 'Preferred',
      range: isMinor ? '$15,100-$59,999' : '$35,000-$59,999',
      ratePerThousand: ageRow[7],
      monthlyCutoff: ageRow[8]
    });
    brackets.push({
      name: 'Executive',
      range: isMinor ? '$60,000-$9,999,999' : '$60,000-$119,999',
      ratePerThousand: ageRow[11],
      monthlyCutoff: ageRow[12]
    });
    
    if (isMinor) {
      brackets.push({
        name: 'Select',
        range: '-',
        ratePerThousand: null,
        monthlyCutoff: null
      });
    } else {
      const selectRate = ageRow[15];
      const selectCeiling = ageRow[16];
      const selectCutoff = selectCeiling !== 9999999 ? (selectCeiling / 1000) * selectRate / 12 : null;
      
      brackets.push({
        name: 'Select',
        range: '$120,000-$9,999,999',
        ratePerThousand: selectRate,
        monthlyCutoff: selectCutoff
      });
    }
  }
  
  return brackets;
}

function getActiveBracket(brackets, policySize, monthlyBudget) {
  if (!brackets) return -1;
  
  if (policySize) {
    // Find which bracket the policy size falls into
    if (policySize <= 15099) return 0;
    if (policySize <= 59999) return 1;
    if (policySize <= 119999) return 2;
    return 3;
  } else if (monthlyBudget) {
    // Find bracket by checking monthly cutoffs
    for (let i = 0; i < brackets.length; i++) {
      const bracket = brackets[i];
      if (!bracket.monthlyCutoff) continue;
      
      if (monthlyBudget <= bracket.monthlyCutoff) {
        return i;
      }
    }
    
    // If above all cutoffs, use last bracket with data
    for (let i = brackets.length - 1; i >= 0; i--) {
      if (brackets[i].ratePerThousand !== null) {
        return i;
      }
    }
  }
  
  return -1;
}

function displayRateTable(age, sex, activeBracketIndex) {
  const table = document.getElementById('rate-table');
  document.getElementById('rateTableAge').textContent = age;
  document.getElementById('rateTableSex').textContent = sex === 'male' ? 'Male' : 'Female';
  
  const brackets = getRateBrackets(age, sex);
  if (!brackets) {
    table.innerHTML = '<tr><td>No rate data available</td></tr>';
    return;
  }
  
  table.innerHTML = '';
  
  // Header row
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th></th>' + brackets.map(b => `<th class="rate-table-cell">${b.name}</th>`).join('');
  table.appendChild(headerRow);
  
  // Range row
  const rangeRow = document.createElement('tr');
  rangeRow.innerHTML = '<td><strong>Coverage Range</strong></td>' + 
    brackets.map((b, i) => `<td class="rate-table-cell ${activeBracketIndex === i ? 'active-rate' : ''}">${b.range}</td>`).join('');
  table.appendChild(rangeRow);
  
  // Rate row
  const rateRow = document.createElement('tr');
  rateRow.innerHTML = '<td><strong>Rate per $1,000</strong></td>' + 
    brackets.map((b, i) => `<td class="rate-table-cell ${activeBracketIndex === i ? 'active-rate' : ''}">${b.ratePerThousand !== null ? '$' + b.ratePerThousand.toFixed(2) : '-'}</td>`).join('');
  table.appendChild(rateRow);
  
  // Monthly cutoff row
  const cutoffRow = document.createElement('tr');
  cutoffRow.innerHTML = '<td><strong>Monthly Premium Cutoff</strong></td>' + 
    brackets.map((b, i) => `<td class="rate-table-cell ${activeBracketIndex === i ? 'active-rate' : ''}">${b.monthlyCutoff !== null ? '$' + b.monthlyCutoff.toFixed(2) : '-'}</td>`).join('');
  table.appendChild(cutoffRow);
}

function handleSexChange() {
  const sex = document.getElementById('sex').value;
  const lifeExpectancy = document.getElementById('lifeExpectancy');
  
  // ALWAYS update life expectancy when sex changes
  if (sex) {
    lifeExpectancy.value = sex === 'female' ? 81 : 76;
  }
  
  handlePersonalInfoChange();
}

function handleBudgetInput() {
  const budget = document.getElementById('monthlyBudget');
  const policy = document.getElementById('policySize');
  const age = parseInt(document.getElementById('age').value);
  const sex = document.getElementById('sex').value;
  
  if (!sex || !age) return;
  
  if (budget.value) {
    policy.classList.add('override');
    policy.value = '';
    
    const monthlyBudget = parseFloat(budget.value);
    const annualBudget = monthlyBudget * 12;
    const brackets = getRateBrackets(age, sex);
    const activeBracket = getActiveBracket(brackets, null, monthlyBudget);
    
    if (brackets && activeBracket >= 0) {
      const rate = brackets[activeBracket].ratePerThousand;
      if (rate) {
        const policySize = (monthlyBudget / rate) * 1000;
        policy.value = Math.round(policySize);
      }
    }
  } else {
    policy.classList.remove('override');
  }
  
  runCalculation();
}

function handlePolicyInput() {
  const budget = document.getElementById('monthlyBudget');
  const policy = document.getElementById('policySize');
  const age = parseInt(document.getElementById('age').value);
  const sex = document.getElementById('sex').value;
  
  if (!sex || !age) return;
  
  if (policy.value) {
    budget.classList.add('override');
    budget.value = '';
    
    const policySize = parseFloat(policy.value);
    const brackets = getRateBrackets(age, sex);
    const activeBracket = getActiveBracket(brackets, policySize, null);
    
    if (brackets && activeBracket >= 0) {
      const rate = brackets[activeBracket].ratePerThousand;
      if (rate) {
        const monthlyBudget = (policySize / 1000) * rate;
        budget.value = monthlyBudget.toFixed(2);
      }
    }
  } else {
    budget.classList.remove('override');
  }
  
  runCalculation();
}

function handlePersonalInfoChange() {
  const budget = document.getElementById('monthlyBudget');
  const policy = document.getElementById('policySize');
  
  if (budget.value && !budget.classList.contains('override')) {
    handleBudgetInput();
  } else if (policy.value && !policy.classList.contains('override')) {
    handlePolicyInput();
  }
  
  updateTimeHorizons();
}

function handleMarketGainInput() {
  const marketGain = document.getElementById('marketGain');
  const percentile = document.getElementById('performancePercentile');
  
  if (marketGain.value) {
    percentile.classList.add('override');
  }
  
  updateTimeHorizons();
  runCalculation();
}

function handlePercentileInput() {
  const marketGain = document.getElementById('marketGain');
  const percentile = document.getElementById('performancePercentile');
  
  if (percentile.value) {
    marketGain.classList.add('override');
  } else {
    marketGain.classList.remove('override');
  }
  
  updateTimeHorizons();
  runCalculation();
}

function updateTimeHorizons() {
  const age = parseInt(document.getElementById('age').value) || 35;
  const retirementAge = parseInt(document.getElementById('retirementAge').value) || 65;
  const lifeExpectancy = parseInt(document.getElementById('lifeExpectancy').value);
  const customAgeCutoff = parseInt(document.getElementById('customAgeCutoff').value) || null;
  const marketGain = parseFloat(document.getElementById('marketGain').value) || 10.4;
  const percentile = parseFloat(document.getElementById('performancePercentile').value) || null;
  
  const timeHorizonRetire = retirementAge - age;
  const timeHorizonDeath = lifeExpectancy ? lifeExpectancy - age : null;
  const timeHorizonCustom = customAgeCutoff ? customAgeCutoff - age : null;
  
  document.getElementById('timeHorizonRetire').value = timeHorizonRetire;
  document.getElementById('timeHorizonDeath').value = timeHorizonDeath !== null ? timeHorizonDeath : '';
  document.getElementById('timeHorizonCustom').value = timeHorizonCustom !== null ? timeHorizonCustom : '';
  
  if (percentile && percentile > 0) {
    const retireGain = getCAGRForPercentile(percentile, timeHorizonRetire);
    const deathGain = timeHorizonDeath ? getCAGRForPercentile(percentile, timeHorizonDeath) : null;
    const customGain = timeHorizonCustom ? getCAGRForPercentile(percentile, timeHorizonCustom) : null;
    
    document.getElementById('marketGainRetire').value = retireGain ? `${retireGain}% (P${percentile})` : '-';
    document.getElementById('marketGainDeath').value = deathGain ? `${deathGain}% (P${percentile})` : '-';
    document.getElementById('marketGainCustom').value = customGain ? `${customGain}% (P${percentile})` : '-';
  } else {
    document.getElementById('marketGainRetire').value = `${marketGain}%`;
    document.getElementById('marketGainDeath').value = timeHorizonDeath ? `${marketGain}%` : '-';
    document.getElementById('marketGainCustom').value = timeHorizonCustom ? `${marketGain}%` : '-';
  }
  
  runCalculation();
}

function runCalculation() {
  if (!calcReady) return;
  
  const age = parseInt(document.getElementById('age').value);
  const sex = document.getElementById('sex').value;
  const lifeExp = parseInt(document.getElementById('lifeExpectancy').value);
  const monthlyBudget = parseFloat(document.getElementById('monthlyBudget').value) || 0;
  const policySize = parseFloat(document.getElementById('policySize').value) || 0;
  
  if (!sex || !age) return;
  
  const inputs = {
    inflation: parseFloat(document.getElementById('inflation').value) / 100,
    marketGain: parseFloat(document.getElementById('marketGain').value) / 100,
    retirementAge: parseInt(document.getElementById('retirementAge').value),
    lifeExpectancy: lifeExp || (sex === 'female' ? 81 : 76),
    tobaccoUser: document.getElementById('tobaccoUser').value === 'true',
    age: age,
    sex: sex,
    monthlyBudget: monthlyBudget,
    policySize: policySize,
    termPolicy: parseInt(document.getElementById('termPolicy').value) || null,
    termBudget: parseFloat(document.getElementById('termBudget').value) || 0,
    customTimeHorizon: parseInt(document.getElementById('customAgeCutoff').value) ? 
      parseInt(document.getElementById('customAgeCutoff').value) - age : null,
    performancePercentile: parseFloat(document.getElementById('performancePercentile').value) || null
  };
  
  const result = window.calcEngine.calculate(inputs);
  
  // Display rate table
  const brackets = getRateBrackets(age, sex);
  const activeBracket = getActiveBracket(brackets, policySize, monthlyBudget);
  displayRateTable(age, sex, activeBracket);
  
  displayResults(result);
}

function displayResults(result) {
  const resultsDiv = document.getElementById('results');
  resultsDiv.classList.add('visible');
  
  displayVariableTable('globals-table', result.globals);
  displayVariableTable('inputs-table', result.inputs);
  displayVariableTable('horizons-table', result.timeHorizons);
  displayVariableTable('insurance-table', result.insurance);
  displayVariableTable('results-table', result.results);
  displayArrays(result.arrays, parseInt(document.getElementById('age').value));

  // Update account values
  const retireHorizon = parseInt(document.getElementById('timeHorizonRetire').value);
  const deathHorizon = parseInt(document.getElementById('timeHorizonDeath').value);
  const customHorizon = parseInt(document.getElementById('timeHorizonCustom').value);
  
  if (result.arrays.accountIfWindowEnded) {
    document.getElementById('accountValueRetire').value = retireHorizon >= 0 ? 
      '$' + (result.arrays.accountIfWindowEnded[retireHorizon] || 0).toLocaleString('en-US', {maximumFractionDigits: 2, minimumFractionDigits: 2}) : '-';
    document.getElementById('accountValueDeath').value = deathHorizon >= 0 ? 
      '$' + (result.arrays.accountIfWindowEnded[deathHorizon] || 0).toLocaleString('en-US', {maximumFractionDigits: 2, minimumFractionDigits: 2}) : '-';
    document.getElementById('accountValueCustom').value = customHorizon >= 0 ? 
      '$' + (result.arrays.accountIfWindowEnded[customHorizon] || 0).toLocaleString('en-US', {maximumFractionDigits: 2, minimumFractionDigits: 2}) : '-';
  }
 
}

function displayVariableTable(tableId, variables) {
  const table = document.getElementById(tableId);
  table.innerHTML = '';
  
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th>Variable</th><th>Value</th></tr>';
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  for (const [key, value] of Object.entries(variables)) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${key}</td>
      <td>${formatValue(value, key)}</td>
    `;
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
}

function getMortalityForYear(currentAge, sex, yearsAhead) {
  if (!window.calcEngine || !window.calcEngine.data.mortality) return null;
  const sexStr = document.getElementById('sex').value;
  const mortality = window.calcEngine.data.mortality[sexStr];
  if (!mortality || !mortality[currentAge]) return null;
  // yearsAhead directly maps to column (1 year = index 1, 20 years = index 20)
  return mortality[currentAge][yearsAhead] || null;
}

function displayArrays(arrays, currentAge) {
  const container = document.getElementById('arrays-container');
  container.innerHTML = '';
  
  const maxLength = Math.max(...Object.values(arrays).map(arr => arr.length));
  
  const table = document.createElement('table');
  table.className = 'array-table';
  
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th>Year</th><th>Age</th>';
  
  const columnNames = Object.keys(arrays).filter(k => k !== 'year');
  columnNames.push('mortalityLikelihood'); // Add mortality column
  for (const key of columnNames) {
    headerRow.innerHTML += `<th>${key}</th>`;
  }
  thead.appendChild(headerRow);
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  for (let i = 0; i < maxLength; i++) {
    const row = document.createElement('tr');
    const age = currentAge + i;
    row.innerHTML = `<td>${i}</td><td>${age}</td>`;
    
    columnNames.forEach(key => {
      if (key === 'mortalityLikelihood') {
        // Get mortality from data - use the age at that year, not current age
        const ageAtYear = currentAge + i;
        const sex = document.getElementById('sex').value;
        const mortality = window.calcEngine?.data?.mortality?.[sex]?.[ageAtYear]?.[1] || null;
        row.innerHTML += `<td>${mortality !== null ? (mortality * 100).toFixed(2) + '%' : '-'}</td>`;
      } else {
        const arr = arrays[key];
        const value = arr[i];
        
        let cellClass = '';
        if (['marketGainsTotal', 'paidInTotal', 'payInYearAdjusted', 'paidInTotalAdjusted', 'totalInAccountAdjusted'].includes(key)) {
          cellClass = 'col-grey';
        } else if (key === 'accountIfWindowEnded') {
          cellClass = 'col-blue';
        } else if (key === 'totalInAccount') {
          cellClass = 'col-green';
        }
        
        row.innerHTML += `<td class="${cellClass}">${formatValue(value, key)}</td>`;
      }
    });
    
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
  
  container.appendChild(table);
}

function formatValue(value, key) {
  if (value === null || value === undefined) {
    return '-';
  }
  if (typeof value === 'number') {
    // No decimals for years/ages/horizons
    if (key && (key.includes('AGE') || key.includes('YEAR') || key.includes('HORIZON') || 
                key === 'year' || key === 'LIFE_EXPECTANCY' || 
                key === 'TIME_HORIZON_DEATH' || key === 'TIME_HORIZON_RETIRE' || 
                key === 'ACTIVE_TIME_HORIZON')) {
      return Math.round(value).toString();
    }
    
    // 4 decimals for mortality and inflation
    if (key === 'MORTALITY_LIKELIHOOD' || key === 'inflationValue') {
      return value.toFixed(4);
    }
    
    // Dollar amounts with $ and commas, 2 decimals
    if (key === 'MONTHLY_BUDGET' || key === 'POLICY_SIZE' || key === 'TERM_BUDGET' || 
        key === 'TERM_POLICY_SIZE' || key === 'WHOLE_LIFE_ANNUAL_COST' || key === 'TERM_ANNUAL_COST' ||
        key === 'ACCOUNT_TOTAL' || key === 'ACCOUNT_TOTAL_ADJUSTED' || 
        key === 'ACCOUNT_INCOME' || key === 'FINAL_YEAR_GROWTH' ||
        key === 'TOTAL_PAID_IN' || key === 'TOTAL_PAID_IN_ADJUSTED' ||
        key === 'TOTAL_MARKET_GAINS' || key === 'TOTAL_TERM_COST' ||
        key === 'payInYear' || key === 'paidInTotal' || key === 'payInYearAdjusted' ||
        key === 'paidInTotalAdjusted' || key === 'marketGainsYear' || key === 'marketGainsTotal' ||
        key === 'accountIfWindowEnded' || key === 'totalInAccount' || key === 'totalInAccountAdjusted' ||
        key === 'termSetAside') {
      return '$' + value.toLocaleString('en-US', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    }
    
    // Rates (no $ sign)
    if (key === 'WHOLE_LIFE_RATE' || key === 'TERM_RATE') {
      return '$' + value.toFixed(2);
    }
    
    // Everything else 2 decimals with commas
    if (value > 100 || value < -100) {
      return value.toLocaleString('en-US', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    }
    
    return value.toFixed(4);
  }
  if (typeof value === 'boolean') {
    return value ? 'Yes' : 'No';
  }
  return String(value);
}

// Display last updated timestamp
document.getElementById('last-updated').textContent = '2/12/2026, 8:57 PM';
 
init();
</script>

</body>
</html>
