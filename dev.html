<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculator Dev Tool | StartWith60</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="/data-loader.js"></script>
<script src="/calc-engine.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: Arial, sans-serif;
    background: white;
    color: #333;
    padding: 20px;
    font-size: 13px;
  }
  
  h1 { font-size: 20px; margin-bottom: 15px; }
  h2 { font-size: 14px; margin-top: 15px; margin-bottom: 8px; font-weight: bold; }
  
  .version-stamps {
    position: fixed;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 10px;
    z-index: 1000;
  }
  
  .version-stamp {
    padding: 5px 10px;
    border: 1px solid #ccc;
    font-size: 11px;
    border-radius: 3px;
  }
  
  .version-stamp.page {
    background: #fee;
    color: #c00;
    border-color: #fcc;
  }
  
  .version-stamp.engine {
    background: #ffe;
    color: #c60;
    border-color: #fc9;
  }
  
  .input-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
  }
  
  .input-row label {
    width: 200px;
    font-size: 12px;
  }
  
  .input-row input,
  .input-row select {
    width: 120px;
    padding: 4px;
    border: 1px solid #ccc;
    background: #f5f5f5;
    font-size: 12px;
  }
  
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  
  input[type="number"] { -moz-appearance: textfield; }
  
  .readonly {
    background: #e9e9e9;
    color: #666;
  }
  
  .override {
    background: #e3f2fd;
  }
  
  .tables-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
  }
  
  th {
    background: #e9e9e9;
    padding: 4px;
    border: 1px solid #ccc;
    font-weight: bold;
    text-align: left;
    font-size: 10px;
    white-space: nowrap;
  }
  
  td {
    padding: 3px 4px;
    border: 1px solid #ddd;
    text-align: left;
    white-space: nowrap;
  }
  
  tr:nth-child(even) { background: #fafafa; }
  
  .rate-table-cell {
    text-align: center;
  }
  
  .active-rate {
    background: #e8f5e9 !important;
    font-weight: bold;
  }
  
  .array-table {
    margin-top: 15px;
    font-size: 10px;
    width: auto;
    table-layout: auto;
  }
  
  .array-table th {
    position: sticky;
    top: 0;
    background: #e9e9e9;
    font-size: 9px;
    padding: 3px 5px;
    white-space: nowrap;
  }
  
  .array-table td {
    padding: 2px 5px;
    text-align: right;
    white-space: nowrap;
  }
  
  .array-table td:first-child,
  .array-table td:nth-child(2) {
    text-align: center;
    font-weight: bold;
  }
  
  .col-grey { background: #f0f0f0 !important; }
  .col-blue { background: #e3f2fd !important; }
  .col-green { background: #e8f5e9 !important; }
  
  .error {
    background: #fee;
    color: #c00;
    padding: 10px;
    border: 1px solid #fcc;
    margin: 10px 0;
  }
  
  #results { display: none; }
  #results.visible { display: block; }
</style>
</head>
<body>

 <!-- TIME STAMP -->
 <!-- TIME STAMP -->
 <!-- TIME STAMP -->
 
<div class="version-stamps">
  <div class="version-stamp engine">
    Engine: <span id="engine-version">Loading...</span>
  </div>
  <div class="version-stamp page">
    Page: <span id="page-version">2/13/2026, 3:41 PM</span>
  </div>
</div>

 <!-- TIME STAMP -->
 <!-- TIME STAMP -->
 <!-- TIME STAMP -->

<h1>Calculator Dev Tool</h1>

<div>
  <h2>Global Variables</h2>
  <div class="input-row">
    <label>Market Gain (%):</label>
    <input type="number" id="marketGain" value="10.4" step="0.1" oninput="handleMarketGainInput()">
  </div>
  <div class="input-row">
    <label>Inflation Rate (%):</label>
    <input type="number" id="inflation" value="3.28" step="0.01" oninput="runCalculation()">
  </div>
 
  <h2>Personal Info</h2>
  <div class="input-row">
    <label>Sex:</label>
    <select id="sex" onchange="handleSexChange()">
      <option value="">Select...</option>
      <option value="male">Male</option>
      <option value="female">Female</option>
    </select>
  </div>
  <div class="input-row">
    <label>Current Age:</label>
    <input type="number" id="age" placeholder="Enter age" oninput="handlePersonalInfoChange()">
  </div>
  <div class="input-row">
    <label>Tobacco User:</label>
    <select id="tobaccoUser" onchange="handlePersonalInfoChange()">
      <option value="false">No</option>
      <option value="true">Yes</option>
    </select>
  </div>
 
  <h2>Budget & Insurance</h2>
  <div class="input-row">
    <label>Monthly Budget ($):</label>
    <input type="number" id="monthlyBudget" placeholder="Enter amount" oninput="handleBudgetInput()">
    <span style="margin: 0 10px;">OR</span>
    <label>Whole Life Policy ($):</label>
    <input type="number" id="policySize" class="override" placeholder="Enter amount" oninput="handlePolicyInput()">
  </div>
  <div class="input-row">
  <label>Term Length:</label>
  <select id="termPolicy" onchange="runCalculation()">
    <option value="">None</option>
    <option value="10 YEAR">10 Year Term</option>
    <!-- Additional term options can be added here -->
  </select>
</div>
  <div class="input-row">
    <label>Term Budget ($/mo):</label>
    <input type="number" id="termBudget" value="0" oninput="runCalculation()">
  </div>

  <h2>Time Horizons</h2>
  <div class="input-row">
    <label>Retirement Age:</label>
    <input type="number" id="retirementAge" value="65" oninput="updateTimeHorizons()">
    <span style="margin-left: 10px; color: #666;">Time Horizon:</span>
    <input type="text" id="timeHorizonRetire" class="readonly" readonly style="width: 50px;">
    <span style="margin-left: 10px; color: #666;">Market Gain YoY:</span>
    <input type="text" id="marketGainRetire" class="readonly" readonly style="width: 100px;">
    <span style="margin-left: 10px; color: #666;">Account Value:</span>
    <input type="text" id="accountValueRetire" class="readonly" readonly style="width: 120px;">
  </div>
  <div class="input-row">
    <label>Life Expectancy:</label>
    <input type="number" id="lifeExpectancy" placeholder="Auto-fills from sex" oninput="updateTimeHorizons()">
    <span style="margin-left: 10px; color: #666;">Time Horizon:</span>
    <input type="text" id="timeHorizonDeath" class="readonly" readonly style="width: 50px;">
    <span style="margin-left: 10px; color: #666;">Market Gain YoY:</span>
    <input type="text" id="marketGainDeath" class="readonly" readonly style="width: 100px;">
    <span style="margin-left: 10px; color: #666;">Account Value:</span>
    <input type="text" id="accountValueDeath" class="readonly" readonly style="width: 120px;">
  </div>
  <div class="input-row">
    <label>Custom Age Cutoff:</label>
    <input type="number" id="customAgeCutoff" placeholder="Leave empty" oninput="updateTimeHorizons()">
    <span style="margin-left: 10px; color: #666;">Time Horizon:</span>
    <input type="text" id="timeHorizonCustom" class="readonly" readonly style="width: 50px;">
    <span style="margin-left: 10px; color: #666;">Market Gain YoY:</span>
    <input type="text" id="marketGainCustom" class="readonly" readonly style="width: 100px;">
    <span style="margin-left: 10px; color: #666;">Account Value:</span>
    <input type="text" id="accountValueCustom" class="readonly" readonly style="width: 120px;">
  </div>
  
  <h2>Advanced</h2>
  <div class="input-row">
    <label>Performance Percentile (%):</label>
    <input type="number" id="performancePercentile" class="override" placeholder="Leave empty for default" oninput="handlePercentileInput()">
  </div>
</div>

<div id="loading" style="display:none; margin: 10px 0; color: #666;">Loading...</div>
<div id="error" class="error" style="display:none;"></div>

<div id="results">
  <h2>Insurance Rate Table (Age <span id="rateTableAge"></span>, <span id="rateTableSex"></span>)</h2>
  <table id="rate-table"></table>
  
  <div class="tables-container" id="sections-container"></div>
  
  <h2>Year-by-Year Breakdown</h2>
  <div id="arrays-container"></div>
</div>

<script>
let calcReady = false;

async function init() {
  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  
  loading.style.display = 'block';
  
  try {
    await initCalcEngine();
    
    // Display engine version
    document.getElementById('engine-version').textContent = window.calcEngine.VERSION;
    
    calcReady = true;
    loading.style.display = 'none';
  } catch (err) {
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = `Error loading: ${err.message}`;
    console.error(err);
  }
}

function handleSexChange() {
  const sex = document.getElementById('sex').value;
  const lifeExpectancy = document.getElementById('lifeExpectancy');
  
  if (sex) {
    lifeExpectancy.value = sex === 'female' ? 81 : 76;
  }
  
  handlePersonalInfoChange();
}

async function handleBudgetInput() {
  const budget = document.getElementById('monthlyBudget');
  const policy = document.getElementById('policySize');
  const age = parseInt(document.getElementById('age').value);
  const sex = document.getElementById('sex').value;
  
  if (!sex || !age) return;
  
  if (budget.value) {
    policy.classList.add('override');
    policy.value = '';
    
    const monthlyBudget = parseFloat(budget.value);
    const brackets = await window.calcEngine.getRateBrackets(age, sex);
    const activeBracket = window.calcEngine.getActiveBracket(brackets, null, monthlyBudget);
    
    if (brackets && activeBracket >= 0) {
      const rate = brackets[activeBracket].ratePerThousand;
      if (rate) {
        const policySize = (monthlyBudget / rate) * 1000;
        policy.value = Math.round(policySize);
      }
    }
  } else {
    policy.classList.remove('override');
  }
  
  runCalculation();
}

async function handlePolicyInput() {
  const budget = document.getElementById('monthlyBudget');
  const policy = document.getElementById('policySize');
  const age = parseInt(document.getElementById('age').value);
  const sex = document.getElementById('sex').value;
  
  if (!sex || !age) return;
  
  if (policy.value) {
    budget.classList.add('override');
    budget.value = '';
    
    const policySize = parseFloat(policy.value);
    const brackets = await window.calcEngine.getRateBrackets(age, sex);
    const activeBracket = window.calcEngine.getActiveBracket(brackets, policySize, null);
    
    if (brackets && activeBracket >= 0) {
      const rate = brackets[activeBracket].ratePerThousand;
      if (rate) {
        const monthlyBudget = (policySize / 1000) * rate;
        budget.value = monthlyBudget.toFixed(2);
      }
    }
  } else {
    budget.classList.remove('override');
  }
  
  runCalculation();
}

function handlePersonalInfoChange() {
  const budget = document.getElementById('monthlyBudget');
  const policy = document.getElementById('policySize');
  
  if (budget.value && !budget.classList.contains('override')) {
    handleBudgetInput();
  } else if (policy.value && !policy.classList.contains('override')) {
    handlePolicyInput();
  }
  
  runCalculation();
}

function handleMarketGainInput() {
  const marketGain = document.getElementById('marketGain');
  const percentile = document.getElementById('performancePercentile');
  
  if (marketGain.value) {
    percentile.classList.add('override');
  }
  
  runCalculation();
}

function handlePercentileInput() {
  const marketGain = document.getElementById('marketGain');
  const percentile = document.getElementById('performancePercentile');
  
  if (percentile.value) {
    marketGain.classList.add('override');
  } else {
    marketGain.classList.remove('override');
  }
  
  runCalculation();
}

function updateTimeHorizons() {
  runCalculation();
}

async function runCalculation() {
  if (!calcReady) return;
  
  const age = parseInt(document.getElementById('age').value);
  const sex = document.getElementById('sex').value;
  const lifeExp = parseInt(document.getElementById('lifeExpectancy').value);
  const monthlyBudget = parseFloat(document.getElementById('monthlyBudget').value) || 0;
  const policySize = parseFloat(document.getElementById('policySize').value) || 0;
  const percentile = parseFloat(document.getElementById('performancePercentile').value) || null;
  
  if (!sex || !age) return;
  
  // Calculate market gain based on percentile
  let marketGain = parseFloat(document.getElementById('marketGain').value) / 100 || 0.104;
  
  if (percentile) {
    const retirementAge = parseInt(document.getElementById('retirementAge').value) || 65;
    const timeHorizon = retirementAge - age;
    const cagrPercentile = window.calcEngine.getCAGRForPercentile(percentile, timeHorizon);
    if (cagrPercentile) {
      marketGain = parseFloat(cagrPercentile) / 100;
    }
  }
  
  const inputs = {
    inflation: parseFloat(document.getElementById('inflation').value) / 100,
    marketGain: marketGain,
    retirementAge: parseInt(document.getElementById('retirementAge').value),
    lifeExpectancy: lifeExp || (sex === 'female' ? 81 : 76),
    tobaccoUser: document.getElementById('tobaccoUser').value === 'true',
    age: age,
    sex: sex,
    monthlyBudget: monthlyBudget,
    policySize: policySize,
    termPolicy: parseInt(document.getElementById('termPolicy').value) || null,
    termBudget: parseFloat(document.getElementById('termBudget').value) || 0,
    customTimeHorizon: parseInt(document.getElementById('customAgeCutoff').value) ? 
      parseInt(document.getElementById('customAgeCutoff').value) - age : null,
    performancePercentile: percentile
  };
  
  try {
    const result = await window.calcEngine.calculate(inputs);
    displayResults(result);
    updateTimeHorizonDisplays(result, percentile);
  } catch (err) {
    console.error('Calculation error:', err);
    document.getElementById('error').style.display = 'block';
    document.getElementById('error').textContent = `Calculation error: ${err.message}`;
  }
}

function updateTimeHorizonDisplays(result, percentile) {
  const age = parseInt(document.getElementById('age').value);
  const retirementAge = parseInt(document.getElementById('retirementAge').value);
  const lifeExpectancy = parseInt(document.getElementById('lifeExpectancy').value);
  const customAgeCutoff = parseInt(document.getElementById('customAgeCutoff').value);
  
  const retireHorizon = retirementAge - age;
  const deathHorizon = lifeExpectancy - age;
  const customHorizon = customAgeCutoff - age;
  
  document.getElementById('timeHorizonRetire').value = retireHorizon;
  document.getElementById('timeHorizonDeath').value = lifeExpectancy ? deathHorizon : '';
  document.getElementById('timeHorizonCustom').value = customAgeCutoff ? customHorizon : '';
  
  // Market gain displays
  if (percentile) {
    const retireGain = window.calcEngine.getCAGRForPercentile(percentile, retireHorizon);
    const deathGain = lifeExpectancy ? window.calcEngine.getCAGRForPercentile(percentile, deathHorizon) : null;
    const customGain = customAgeCutoff ? window.calcEngine.getCAGRForPercentile(percentile, customHorizon) : null;
    
    document.getElementById('marketGainRetire').value = retireGain ? `${retireGain}% (P${percentile})` : '-';
    document.getElementById('marketGainDeath').value = deathGain ? `${deathGain}% (P${percentile})` : '';
    document.getElementById('marketGainCustom').value = customGain ? `${customGain}% (P${percentile})` : '';
  } else {
    const marketGain = parseFloat(document.getElementById('marketGain').value);
    document.getElementById('marketGainRetire').value = `${marketGain}%`;
    document.getElementById('marketGainDeath').value = lifeExpectancy ? `${marketGain}%` : '';
    document.getElementById('marketGainCustom').value = customAgeCutoff ? `${marketGain}%` : '';
  }
  
  // Account values
  if (result.arrays.accountIfWindowEnded) {
    document.getElementById('accountValueRetire').value = retireHorizon >= 0 ? 
      '$' + (result.arrays.accountIfWindowEnded[retireHorizon] || 0).toLocaleString('en-US', {maximumFractionDigits: 2, minimumFractionDigits: 2}) : '-';
    document.getElementById('accountValueDeath').value = lifeExpectancy && deathHorizon >= 0 ? 
      '$' + (result.arrays.accountIfWindowEnded[deathHorizon] || 0).toLocaleString('en-US', {maximumFractionDigits: 2, minimumFractionDigits: 2}) : '';
    document.getElementById('accountValueCustom').value = customAgeCutoff && customHorizon >= 0 ? 
      '$' + (result.arrays.accountIfWindowEnded[customHorizon] || 0).toLocaleString('en-US', {maximumFractionDigits: 2, minimumFractionDigits: 2}) : '';
  }
}

function displayResults(result) {
  const resultsDiv = document.getElementById('results');
  resultsDiv.classList.add('visible');
  
  // Display rate table
  displayRateTable(result.tables.rateTable);
  
  // Auto-generate section tables
  const sectionsContainer = document.getElementById('sections-container');
  sectionsContainer.innerHTML = '';
  
  for (const [sectionName, variables] of Object.entries(result.sections)) {
    const div = document.createElement('div');
    const h2 = document.createElement('h2');
    h2.textContent = sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
    
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th>Variable</th><th>Value</th></tr>';
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    for (const [key, value] of Object.entries(variables)) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${key}</td>
        <td>${formatValue(value, key)}</td>
      `;
      tbody.appendChild(row);
    }
    table.appendChild(tbody);
    
    div.appendChild(h2);
    div.appendChild(table);
    sectionsContainer.appendChild(div);
  }
  
  // Display arrays
  displayArrays(result.arrays, parseInt(document.getElementById('age').value));
}

function displayRateTable(rateTableData) {
  const table = document.getElementById('rate-table');
  document.getElementById('rateTableAge').textContent = rateTableData.age;
  document.getElementById('rateTableSex').textContent = rateTableData.sex === 'male' ? 'Male' : 'Female';
  
  const brackets = rateTableData.brackets;
  if (!brackets) {
    table.innerHTML = '<tr><td>No rate data available</td></tr>';
    return;
  }
  
  table.innerHTML = '';
  
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th></th>' + brackets.map(b => `<th class="rate-table-cell">${b.name}</th>`).join('');
  table.appendChild(headerRow);
  
  const rangeRow = document.createElement('tr');
  rangeRow.innerHTML = '<td><strong>Coverage Range</strong></td>' + 
    brackets.map((b, i) => `<td class="rate-table-cell ${rateTableData.activeBracketIndex === i ? 'active-rate' : ''}">${b.range}</td>`).join('');
  table.appendChild(rangeRow);
  
  const rateRow = document.createElement('tr');
  rateRow.innerHTML = '<td><strong>Rate per $1,000</strong></td>' + 
    brackets.map((b, i) => `<td class="rate-table-cell ${rateTableData.activeBracketIndex === i ? 'active-rate' : ''}">${b.ratePerThousand !== null ? '$' + b.ratePerThousand.toFixed(2) : '-'}</td>`).join('');
  table.appendChild(rateRow);
  
  const cutoffRow = document.createElement('tr');
  cutoffRow.innerHTML = '<td><strong>Monthly Premium Cutoff</strong></td>' + 
    brackets.map((b, i) => `<td class="rate-table-cell ${rateTableData.activeBracketIndex === i ? 'active-rate' : ''}">${b.monthlyCutoff !== null ? '$' + b.monthlyCutoff.toFixed(2) : '-'}</td>`).join('');
  table.appendChild(cutoffRow);
}

function displayArrays(arrays, currentAge) {
  const container = document.getElementById('arrays-container');
  container.innerHTML = '';
  
  const maxLength = Math.max(...Object.values(arrays).map(arr => arr.length));
  
  const table = document.createElement('table');
  table.className = 'array-table';
  
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th>Year</th><th>Age</th>';
  
  const columnNames = Object.keys(arrays).filter(k => k !== 'year');
  for (const key of columnNames) {
    headerRow.innerHTML += `<th>${key}</th>`;
  }
  thead.appendChild(headerRow);
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  for (let i = 0; i < maxLength; i++) {
    const row = document.createElement('tr');
    const age = currentAge + i;
    row.innerHTML = `<td>${i}</td><td>${age}</td>`;
    
    columnNames.forEach(key => {
      const arr = arrays[key];
      const value = arr[i];
      
      let cellClass = '';
      if (['marketGainsTotal', 'paidInTotal', 'payInYearAdjusted', 'paidInTotalAdjusted', 'totalInAccountAdjusted'].includes(key)) {
        cellClass = 'col-grey';
      } else if (key === 'accountIfWindowEnded') {
        cellClass = 'col-blue';
      } else if (key === 'totalInAccount') {
        cellClass = 'col-green';
      }
      
      row.innerHTML += `<td class="${cellClass}">${formatValue(value, key)}</td>`;
    });
    
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
  
  container.appendChild(table);
}

function formatValue(value, key) {
  if (value === null || value === undefined) {
    return '-';
  }
  if (typeof value === 'number') {
    if (key && (key.includes('AGE') || key.includes('YEAR') || key.includes('HORIZON') || 
                key === 'year' || key === 'LIFE_EXPECTANCY' || 
                key === 'TIME_HORIZON_DEATH' || key === 'TIME_HORIZON_RETIRE' || 
                key === 'ACTIVE_TIME_HORIZON')) {
      return Math.round(value).toString();
    }
    
    if (key === 'MORTALITY_LIKELIHOOD' || key === 'inflationValue' || key === 'mortalityLikelihood') {
      if (key === 'mortalityLikelihood') {
        return (value * 100).toFixed(2) + '%';
      }
      return value.toFixed(4);
    }
    
    if (key === 'MONTHLY_BUDGET' || key === 'POLICY_SIZE' || key === 'TERM_BUDGET' || 
        key === 'TERM_POLICY_SIZE' || key === 'WHOLE_LIFE_ANNUAL_COST' || key === 'TERM_ANNUAL_COST' ||
        key === 'ACCOUNT_TOTAL' || key === 'ACCOUNT_TOTAL_ADJUSTED' || 
        key === 'ACCOUNT_INCOME' || key === 'FINAL_YEAR_GROWTH' ||
        key === 'TOTAL_PAID_IN' || key === 'TOTAL_PAID_IN_ADJUSTED' ||
        key === 'TOTAL_MARKET_GAINS' || key === 'TOTAL_TERM_COST' ||
        key === 'payInYear' || key === 'paidInTotal' || key === 'payInYearAdjusted' ||
        key === 'paidInTotalAdjusted' || key === 'marketGainsYear' || key === 'marketGainsTotal' ||
        key === 'accountIfWindowEnded' || key === 'totalInAccount' || key === 'totalInAccountAdjusted' ||
        key === 'termSetAside') {
      return '$' + value.toLocaleString('en-US', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    }
    
    if (key === 'WHOLE_LIFE_RATE' || key === 'TERM_RATE') {
      return '$' + value.toFixed(2);
    }
    
    if (value > 100 || value < -100) {
      return value.toLocaleString('en-US', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    }
    
    return value.toFixed(4);
  }
  if (typeof value === 'boolean') {
    return value ? 'Yes' : 'No';
  }
  return String(value);
}

init();
</script>

</body>
</html>
