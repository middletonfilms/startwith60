<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculator Dev Tool | StartWith60</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="/data-loader.js"></script>
<script src="/calc-engine.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: 'Courier New', monospace;
    background: #0f172a;
    color: #e2e8f0;
    padding: 2rem;
    line-height: 1.6;
  }
  
  h1 {
    color: #10b981;
    margin-bottom: 2rem;
    font-size: 2rem;
  }
  
  h2 {
    color: #fbbf24;
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-size: 1.5rem;
    border-bottom: 2px solid #334155;
    padding-bottom: 0.5rem;
  }
  
  .section {
    background: #1e293b;
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
    border: 1px solid #334155;
  }
  
  .input-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .input-group {
    display: flex;
    flex-direction: column;
  }
  
  label {
    color: #94a3b8;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  input, select {
    background: #0f172a;
    border: 1px solid #475569;
    color: #e2e8f0;
    padding: 0.5rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
  }
  
  input:focus, select:focus {
    outline: none;
    border-color: #10b981;
  }
  
  button {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 0.5rem;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  button:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
  }
  
  .variable-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
  }
  
  .variable-table th {
    background: #0f172a;
    text-align: left;
    padding: 0.75rem;
    border: 1px solid #475569;
    color: #fbbf24;
    font-weight: bold;
  }
  
  .variable-table td {
    padding: 0.75rem;
    border: 1px solid #475569;
  }
  
  .variable-table tr:nth-child(even) {
    background: #0f172a;
  }
  
  .var-name {
    color: #60a5fa;
    font-weight: bold;
  }
  
  .var-value {
    color: #10b981;
    font-family: monospace;
  }
  
  .array-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    font-size: 0.875rem;
  }
  
  .array-table th {
    background: #0f172a;
    padding: 0.5rem;
    border: 1px solid #475569;
    color: #fbbf24;
    position: sticky;
    top: 0;
  }
  
  .array-table td {
    padding: 0.5rem;
    border: 1px solid #475569;
    text-align: right;
  }
  
  .array-table td:first-child {
    color: #60a5fa;
    font-weight: bold;
  }
  
  .loading {
    text-align: center;
    padding: 2rem;
    color: #94a3b8;
  }
  
  .error {
    background: #7f1d1d;
    color: #fecaca;
    padding: 1rem;
    border-radius: 0.5rem;
    border: 1px solid #991b1b;
  }
  
  #results {
    display: none;
  }
  
  #results.visible {
    display: block;
  }
</style>
</head>
<body>

<h1>ðŸ“Š CALCULATOR DEV TOOL</h1>

<div class="section">
  <h2>USER INPUTS</h2>
  
  <div class="input-grid">
    <!-- Global Variables -->
    <div class="input-group">
      <label>Inflation Rate (%)</label>
      <input type="number" id="inflation" value="3.28" step="0.01">
    </div>
    
    <div class="input-group">
      <label>Market Gain (%)</label>
      <input type="number" id="marketGain" value="10.4" step="0.1">
    </div>
    
    <div class="input-group">
      <label>Retirement Age</label>
      <input type="number" id="retirementAge" value="65">
    </div>
    
    <div class="input-group">
      <label>Life Expectancy</label>
      <input type="number" id="lifeExpectancy" value="76">
    </div>
    
    <div class="input-group">
      <label>Tobacco User</label>
      <select id="tobaccoUser">
        <option value="false">No</option>
        <option value="true">Yes</option>
      </select>
    </div>
    
    <!-- Required Inputs -->
    <div class="input-group">
      <label>Current Age</label>
      <input type="number" id="age" value="35" required>
    </div>
    
    <div class="input-group">
      <label>Sex</label>
      <select id="sex" required>
        <option value="male">Male</option>
        <option value="female">Female</option>
      </select>
    </div>
    
    <div class="input-group">
      <label>Monthly Budget ($)</label>
      <input type="number" id="monthlyBudget" value="100" required>
    </div>
    
    <div class="input-group">
      <label>Policy Size ($)</label>
      <input type="number" id="policySize" value="60000">
    </div>
    
    <!-- Optional Inputs -->
    <div class="input-group">
      <label>Term Policy (Years)</label>
      <input type="number" id="termPolicy" placeholder="Leave empty if none">
    </div>
    
    <div class="input-group">
      <label>Term Budget ($/mo)</label>
      <input type="number" id="termBudget" value="0">
    </div>
    
    <div class="input-group">
      <label>Custom Time Horizon (Years)</label>
      <input type="number" id="customTimeHorizon" placeholder="Leave empty for life expectancy">
    </div>
    
    <div class="input-group">
      <label>Performance Percentile (%)</label>
      <input type="number" id="performancePercentile" placeholder="Leave empty for default 10.4%">
    </div>
  </div>
  
  <button onclick="runCalculation()">ðŸš€ RUN CALCULATION</button>
</div>

<div id="loading" class="loading" style="display:none;">
  Loading data files...
</div>

<div id="error" class="error" style="display:none;"></div>

<div id="results">
  <div class="section">
    <h2>GLOBAL VARIABLES</h2>
    <table class="variable-table" id="globals-table"></table>
  </div>
  
  <div class="section">
    <h2>USER INPUTS</h2>
    <table class="variable-table" id="inputs-table"></table>
  </div>
  
  <div class="section">
    <h2>TIME HORIZONS</h2>
    <table class="variable-table" id="horizons-table"></table>
  </div>
  
  <div class="section">
    <h2>INSURANCE RATES</h2>
    <table class="variable-table" id="insurance-table"></table>
  </div>
  
  <div class="section">
    <h2>FINAL RESULTS</h2>
    <table class="variable-table" id="results-table"></table>
  </div>
  
  <div class="section">
    <h2>ARRAYS</h2>
    <div id="arrays-container"></div>
  </div>
</div>

<script>
let calcReady = false;

// Wait for calc engine to initialize
async function init() {
  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  
  loading.style.display = 'block';
  
  try {
    await initCalcEngine();
    calcReady = true;
    loading.style.display = 'none';
  } catch (err) {
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = `Error loading data: ${err.message}`;
    console.error(err);
  }
}

function runCalculation() {
  if (!calcReady) {
    alert('Calculator not ready yet. Please wait...');
    return;
  }
  
  // Gather inputs
  const inputs = {
    inflation: parseFloat(document.getElementById('inflation').value) / 100,
    marketGain: parseFloat(document.getElementById('marketGain').value) / 100,
    retirementAge: parseInt(document.getElementById('retirementAge').value),
    lifeExpectancy: parseInt(document.getElementById('lifeExpectancy').value),
    tobaccoUser: document.getElementById('tobaccoUser').value === 'true',
    age: parseInt(document.getElementById('age').value),
    sex: document.getElementById('sex').value,
    monthlyBudget: parseFloat(document.getElementById('monthlyBudget').value),
    policySize: parseFloat(document.getElementById('policySize').value) || 0,
    termPolicy: parseInt(document.getElementById('termPolicy').value) || null,
    termBudget: parseFloat(document.getElementById('termBudget').value) || 0,
    customTimeHorizon: parseInt(document.getElementById('customTimeHorizon').value) || null,
    performancePercentile: parseFloat(document.getElementById('performancePercentile').value) || null
  };
  
  // Run calculation
  const result = window.calcEngine.calculate(inputs);
  
  // Display results
  displayResults(result);
}

function displayResults(result) {
  const resultsDiv = document.getElementById('results');
  resultsDiv.classList.add('visible');
  
  // Display globals
  displayVariableTable('globals-table', result.globals);
  
  // Display inputs
  displayVariableTable('inputs-table', result.inputs);
  
  // Display time horizons
  displayVariableTable('horizons-table', result.timeHorizons);
  
  // Display insurance
  displayVariableTable('insurance-table', result.insurance);
  
  // Display final results
  displayVariableTable('results-table', result.results);
  
  // Display arrays
  displayArrays(result.arrays);
}

function displayVariableTable(tableId, variables) {
  const table = document.getElementById(tableId);
  table.innerHTML = '';
  
  // Header
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th>Variable</th><th>Value</th></tr>';
  table.appendChild(thead);
  
  // Body
  const tbody = document.createElement('tbody');
  for (const [key, value] of Object.entries(variables)) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="var-name">${key}</td>
      <td class="var-value">${formatValue(value)}</td>
    `;
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
}

function displayArrays(arrays) {
  const container = document.getElementById('arrays-container');
  container.innerHTML = '';
  
  // Get the longest array to determine row count
  const maxLength = Math.max(...Object.values(arrays).map(arr => arr.length));
  
  // Create combined table
  const table = document.createElement('table');
  table.className = 'array-table';
  
  // Header
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th>Index</th>';
  for (const key of Object.keys(arrays)) {
    headerRow.innerHTML += `<th>${key}</th>`;
  }
  thead.appendChild(headerRow);
  table.appendChild(thead);
  
  // Body
  const tbody = document.createElement('tbody');
  for (let i = 0; i < maxLength; i++) {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${i}</td>`;
    
    for (const arr of Object.values(arrays)) {
      const value = arr[i];
      row.innerHTML += `<td>${formatValue(value)}</td>`;
    }
    
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
  
  container.appendChild(table);
}

function formatValue(value) {
  if (value === null || value === undefined) {
    return '<span style="color:#64748b;">null</span>';
  }
  if (typeof value === 'number') {
    if (value > 1000 || value < -1000) {
      return value.toLocaleString('en-US', { maximumFractionDigits: 2 });
    }
    return value.toFixed(4);
  }
  if (typeof value === 'boolean') {
    return value ? 'true' : 'false';
  }
  return String(value);
}

// Initialize on load
init();
</script>

</body>
</html>
