<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculator Dev Tool | StartWith60</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="/data-loader.js"></script>
<script src="/calc-engine.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: Arial, sans-serif;
    background: white;
    color: #333;
    padding: 20px;
    font-size: 13px;
  }
  
  h1 {
    font-size: 20px;
    margin-bottom: 15px;
  }
  
  h2 {
    font-size: 14px;
    margin-top: 15px;
    margin-bottom: 8px;
    font-weight: bold;
  }
  
  .input-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
  }
  
  .input-row label {
    width: 200px;
    font-size: 12px;
  }
  
  .input-row input,
  .input-row select {
    width: 120px;
    padding: 4px;
    border: 1px solid #ccc;
    background: #f5f5f5;
    font-size: 12px;
  }
  
  .input-row .readonly {
    background: #e9e9e9;
    color: #666;
  }
  
  button {
    margin-top: 10px;
    padding: 8px 20px;
    border: 1px solid #ccc;
    background: #f0f0f0;
    cursor: pointer;
    font-size: 13px;
  }
  
  button:hover {
    background: #e0e0e0;
  }
  
  .tables-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
  }
  
  th {
    background: #e9e9e9;
    padding: 4px;
    border: 1px solid #ccc;
    font-weight: bold;
    text-align: left;
    font-size: 10px;
  }
  
  td {
    padding: 3px 4px;
    border: 1px solid #ddd;
    text-align: left;
  }
  
  tr:nth-child(even) {
    background: #fafafa;
  }
  
  .array-table {
    margin-top: 15px;
    font-size: 10px;
  }
  
  .array-table th {
    position: sticky;
    top: 0;
    background: #e9e9e9;
    font-size: 9px;
    padding: 3px;
  }
  
  .array-table td {
    padding: 2px 3px;
    text-align: right;
  }
  
  .array-table td:first-child {
    text-align: center;
    font-weight: bold;
  }
  
  /* Column background colors */
  .col-grey {
    background: #f0f0f0 !important;
  }
  
  .col-blue {
    background: #e3f2fd !important;
  }
  
  .col-green {
    background: #e8f5e9 !important;
  }
  
  .error {
    background: #fee;
    color: #c00;
    padding: 10px;
    border: 1px solid #fcc;
    margin: 10px 0;
  }
  
  #results {
    display: none;
  }
  
  #results.visible {
    display: block;
  }
</style>
</head>
<body>

<h1>Calculator Dev Tool</h1>

<div>
  <h2>Global Variables</h2>
  <div class="input-row">
    <label>Market Gain (%):</label>
    <input type="number" id="marketGain" value="10.4" step="0.1">
  </div>
  <div class="input-row">
    <label>Inflation Rate (%):</label>
    <input type="number" id="inflation" value="3.28" step="0.01">
  </div>
  
  <h2>Budget & Insurance</h2>
  <div class="input-row">
    <label>Monthly Budget ($):</label>
    <input type="number" id="monthlyBudget" value="100">
    <span style="margin: 0 10px;">OR</span>
    <label>Whole Life Policy ($):</label>
    <input type="number" id="policySize" value="60000">
  </div>
  <div class="input-row">
    <label>Term Length (Years):</label>
    <input type="number" id="termPolicy" placeholder="Leave empty if none">
  </div>
  <div class="input-row">
    <label>Term Budget ($/mo):</label>
    <input type="number" id="termBudget" value="0">
  </div>
  
  <h2>Personal Info</h2>
  <div class="input-row">
    <label>Sex:</label>
    <select id="sex">
      <option value="male">Male</option>
      <option value="female">Female</option>
    </select>
  </div>
  <div class="input-row">
    <label>Current Age:</label>
    <input type="number" id="age" value="35">
  </div>
  <div class="input-row">
    <label>Tobacco User:</label>
    <select id="tobaccoUser">
      <option value="false">No</option>
      <option value="true">Yes</option>
    </select>
  </div>
  
  <h2>Time Horizons</h2>
  <div class="input-row">
    <label>Retirement Age:</label>
    <input type="number" id="retirementAge" value="65">
    <span style="margin-left: 10px; color: #666;">Time Horizon Retire:</span>
    <input type="text" id="timeHorizonRetire" class="readonly" readonly>
  </div>
  <div class="input-row">
    <label>Life Expectancy:</label>
    <input type="number" id="lifeExpectancy" value="76">
    <span style="margin-left: 10px; color: #666;">Time Horizon Death:</span>
    <input type="text" id="timeHorizonDeath" class="readonly" readonly>
  </div>
  <div class="input-row">
    <label>Custom Time Horizon (Years):</label>
    <input type="number" id="customTimeHorizon" placeholder="Leave empty for life expectancy">
  </div>
  
  <h2>Advanced</h2>
  <div class="input-row">
    <label>Performance Percentile (%):</label>
    <input type="number" id="performancePercentile" placeholder="Leave empty for default 10.4%">
  </div>
  
  <button onclick="runCalculation()">Run Calculation</button>
</div>

<div id="loading" style="display:none; margin: 10px 0; color: #666;">Loading data files...</div>
<div id="error" class="error" style="display:none;"></div>

<div id="results">
  <div class="tables-container">
    <div>
      <h2>Global Variables</h2>
      <table id="globals-table"></table>
    </div>
    
    <div>
      <h2>User Inputs</h2>
      <table id="inputs-table"></table>
    </div>
    
    <div>
      <h2>Time Horizons</h2>
      <table id="horizons-table"></table>
    </div>
    
    <div>
      <h2>Insurance Rates</h2>
      <table id="insurance-table"></table>
    </div>
    
    <div>
      <h2>Final Results</h2>
      <table id="results-table"></table>
    </div>
  </div>
  
  <h2>Year-by-Year Breakdown</h2>
  <div id="arrays-container"></div>
</div>

<script>
let calcReady = false;

async function init() {
  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  
  loading.style.display = 'block';
  
  try {
    await initCalcEngine();
    calcReady = true;
    loading.style.display = 'none';
  } catch (err) {
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = `Error loading data: ${err.message}`;
    console.error(err);
  }
}

function runCalculation() {
  if (!calcReady) {
    alert('Calculator not ready yet. Please wait...');
    return;
  }
  
  const inputs = {
    inflation: parseFloat(document.getElementById('inflation').value) / 100,
    marketGain: parseFloat(document.getElementById('marketGain').value) / 100,
    retirementAge: parseInt(document.getElementById('retirementAge').value),
    lifeExpectancy: parseInt(document.getElementById('lifeExpectancy').value),
    tobaccoUser: document.getElementById('tobaccoUser').value === 'true',
    age: parseInt(document.getElementById('age').value),
    sex: document.getElementById('sex').value,
    monthlyBudget: parseFloat(document.getElementById('monthlyBudget').value),
    policySize: parseFloat(document.getElementById('policySize').value) || 0,
    termPolicy: parseInt(document.getElementById('termPolicy').value) || null,
    termBudget: parseFloat(document.getElementById('termBudget').value) || 0,
    customTimeHorizon: parseInt(document.getElementById('customTimeHorizon').value) || null,
    performancePercentile: parseFloat(document.getElementById('performancePercentile').value) || null
  };
  
  // Update time horizon displays
  const timeHorizonRetire = inputs.retirementAge - inputs.age;
  const timeHorizonDeath = inputs.lifeExpectancy - inputs.age;
  document.getElementById('timeHorizonRetire').value = timeHorizonRetire;
  document.getElementById('timeHorizonDeath').value = timeHorizonDeath;
  
  const result = window.calcEngine.calculate(inputs);
  displayResults(result);
}

function displayResults(result) {
  const resultsDiv = document.getElementById('results');
  resultsDiv.classList.add('visible');
  
  displayVariableTable('globals-table', result.globals);
  displayVariableTable('inputs-table', result.inputs);
  displayVariableTable('horizons-table', result.timeHorizons);
  displayVariableTable('insurance-table', result.insurance);
  displayVariableTable('results-table', result.results);
  displayArrays(result.arrays);
}

function displayVariableTable(tableId, variables) {
  const table = document.getElementById(tableId);
  table.innerHTML = '';
  
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th>Variable</th><th>Value</th></tr>';
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  for (const [key, value] of Object.entries(variables)) {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${key}</td>
      <td>${formatValue(value, key)}</td>
    `;
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
}

function displayArrays(arrays) {
  const container = document.getElementById('arrays-container');
  container.innerHTML = '';
  
  const maxLength = Math.max(...Object.values(arrays).map(arr => arr.length));
  
  const table = document.createElement('table');
  table.className = 'array-table';
  
  const thead = document.createElement('thead');
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th>Year</th>';
  
  const columnNames = Object.keys(arrays);
  for (const key of columnNames) {
    headerRow.innerHTML += `<th>${key}</th>`;
  }
  thead.appendChild(headerRow);
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  for (let i = 0; i < maxLength; i++) {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${i}</td>`;
    
    columnNames.forEach(key => {
      const arr = arrays[key];
      const value = arr[i];
      
      // Determine cell class based on column
      let cellClass = '';
      if (['marketGainsTotal', 'paidInTotal', 'payInYearAdjusted', 'paidInTotalAdjusted', 'totalInAccountAdjusted'].includes(key)) {
        cellClass = 'col-grey';
      } else if (key === 'accountIfWindowEnded') {
        cellClass = 'col-blue';
      } else if (key === 'totalInAccount') {
        cellClass = 'col-green';
      }
      
      row.innerHTML += `<td class="${cellClass}">${formatValue(value, key)}</td>`;
    });
    
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
  
  container.appendChild(table);
}

function formatValue(value, key) {
  if (value === null || value === undefined) {
    return '-';
  }
  if (typeof value === 'number') {
    // No decimals for years
    if (key && (key.includes('AGE') || key.includes('YEAR') || key.includes('HORIZON') || key === 'year')) {
      return Math.round(value).toString();
    }
    // Regular numbers with decimals
    if (value > 1000 || value < -1000) {
      return value.toLocaleString('en-US', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    }
    return value.toFixed(4);
  }
  if (typeof value === 'boolean') {
    return value ? 'Yes' : 'No';
  }
  return String(value);
}

init();
</script>

</body>
</html>
